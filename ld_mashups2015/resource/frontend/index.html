<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Occurrence</title>

    <style type="text/css">
        .ol-mouse-position{top:8px;right:8px;position:absolute}.ol-scale-line{background:#95b9e6;background:rgba(0,60,136,.3);border-radius:4px;bottom:8px;left:8px;padding:2px;position:absolute}.ol-scale-line-inner{border:1px solid #eee;border-top:none;color:#eee;font-size:10px;text-align:center;margin:1px;padding:0 2px}.ol-unsupported{display:none}.ol-viewport .ol-unselectable{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}.ol-control{position:absolute;background-color:#eee;background-color:rgba(255,255,255,.4);border-radius:4px;padding:2px}.ol-control:hover{background-color:rgba(255,255,255,.6)}.ol-zoom{top:.5em;left:.5em}.ol-rotate{top:.5em;right:.5em;transition:opacity .25s}.ol-rotate.ol-hidden{opacity:0;display:none}.ol-zoom-extent{top:4.643em;left:.5em}.ol-full-screen{right:.5em;top:.5em}@media print{.ol-control{display:none}}.ol-control button{display:block;margin:1px;padding:0;color:#fff;font-size:1.14em;font-weight:700;text-decoration:none;text-align:center;height:1.375em;width:1.375em;line-height:.4em;background-color:#7b98bc;background-color:rgba(0,60,136,.5);border:none;border-radius:2px}.ol-control button::-moz-focus-inner{border:none;padding:0}.ol-zoom-extent button{line-height:1.4em}.ol-compass{display:block;font-weight:400;font-size:1.2em}.ol-touch .ol-control button{font-size:1.5em}.ol-touch .ol-zoom-extent{top:5.5em}.ol-control button:focus,.ol-control button:hover{text-decoration:none;background-color:#4c6079;background-color:rgba(0,60,136,.7)}.ol-zoom-extent button:after{content:"E"}.ol-zoom .ol-zoom-in{border-radius:2px 2px 0 0}.ol-zoom .ol-zoom-out{border-radius:0 0 2px 2px}button.ol-full-screen-false:after{content:"\2194"}button.ol-full-screen-true:after{content:"\00d7"}.ol-attribution{text-align:right;bottom:.5em;right:.5em;max-width:calc(100% - 1.3em)}.ol-attribution ul{margin:0;padding:0 .5em;font-size:.7rem;line-height:1.375em;color:#000;text-shadow:0 0 2px #fff}.ol-attribution li{display:inline;list-style:none;line-height:inherit}.ol-attribution li:not(:last-child):after{content:" "}.ol-attribution img{max-height:2em;max-width:inherit}.ol-attribution button,.ol-attribution ul{display:inline-block}.ol-attribution.ol-collapsed ul{display:none}.ol-attribution.ol-logo-only ul{display:block}.ol-attribution:not(.ol-collapsed){background:rgba(255,255,255,.8)}.ol-attribution.ol-uncollapsible{bottom:0;right:0;border-radius:4px 0 0;height:1.1em;line-height:1em}.ol-attribution.ol-logo-only{background:0 0;bottom:.4em;height:1.1em;line-height:1em}.ol-attribution.ol-uncollapsible img{margin-top:-.2em;max-height:1.6em}.ol-attribution.ol-logo-only button,.ol-attribution.ol-uncollapsible button{display:none}.ol-zoomslider{position:absolute;top:4.5em;left:.5em;background:#eee;background:rgba(255,255,255,.4);width:24px;height:200px}.ol-zoomslider-thumb{position:absolute;background:#7b98bc;background:rgba(0,60,136,.5);border-radius:2px;cursor:pointer;height:10px;width:22px;margin:3px}.ol-touch .ol-zoomslider{top:5.5em;width:2.052em}.ol-touch .ol-zoomslider-thumb{width:1.8em}.ol-overviewmap{position:absolute;left:.5em;bottom:.5em}.ol-overviewmap.ol-uncollapsible{bottom:0;left:0;border-radius:0 4px 0 0}.ol-overviewmap .ol-overviewmap-map,.ol-overviewmap button{display:inline-block}.ol-overviewmap .ol-overviewmap-map{border:1px solid #7b98bc;height:150px;margin:2px;width:150px}.ol-overviewmap:not(.ol-collapsed) button{bottom:1px;left:2px;position:absolute}.ol-overviewmap.ol-collapsed .ol-overviewmap-map,.ol-overviewmap.ol-uncollapsible button{display:none}.ol-overviewmap:not(.ol-collapsed){background:rgba(255,255,255,.8)}.ol-overviewmap-box{border:2px dotted rgba(0,60,136,.7)}

        html, body, .mapdiv {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #images, #searchdiv {
            background-color:rgba(0, 0, 0, 0.5);
            position:fixed;
            top:0px;
            left:0px;
            width:100%;
            height:100%;
            color:#FFFFFF;
            text-align:center;
            vertical-align:middle;
        }


        #mapdiv .ol-zoom .ol-zoom-out {
            margin-top: 204px;
        }
        #mapdiv .ol-zoomslider {
            background-color: transparent;
            top: 2.3em;
        }

        #mapdiv .ol-touch .ol-zoom .ol-zoom-out {
            margin-top: 212px;
        }
        #mapdiv .ol-touch .ol-zoomslider {
            top: 2.75em;
        }

        #mapdiv .ol-zoom-in.ol-has-tooltip:hover [role=tooltip],
        #mapdiv .ol-zoom-in.ol-has-tooltip:focus [role=tooltip] {
            top: 3px;
        }

        #mapdiv .ol-zoom-out.ol-has-tooltip:hover [role=tooltip],
        #mapdiv .ol-zoom-out.ol-has-tooltip:focus [role=tooltip] {
            top: 232px;
        }
    </style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="index.css">
    </head>
</head>
<body onload="loadMap()">
    <script src="http://openlayers.org/en/master/resources/jquery.min.js"></script>
    <script src="lib/jquery.form.min.js"></script>
    <script src="http://openlayers.org/en/v3.0.0/build/ol.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.3/fastclick.js"></script>
    <script language="JavaScript" type="text/javascript">
        var map;
        var lastSearchResults;
        function hideDiv() {
            document.getElementById('searchdiv').style.display = 'none';
            document.getElementById('images').style.display = 'none';
            document.getElementById('images').innerHTML= '';
        }
        
        $('#the-element').click(function () { /* perform action here */ });

        function showSearch() {
            for (var el = 0;  el < document.getElementById('searchform').getElementsByTagName('label').length; el++) {
                document.getElementById('searchform').getElementsByTagName('label')[el].style.display="";
            }
            for (var el = 0; el < document.getElementById('searchform').getElementsByTagName('input').length; el++) {
                document.getElementById('searchform').getElementsByTagName('input')[el].style.display="";
            }
        }

        function getRendererFromQueryString() {
            var obj = {}, queryString = location.search.slice(1),
                    re = /([^&=]+)=([^&]*)/g, m;

            while (m = re.exec(queryString)) {
                obj[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            if ('renderers' in obj) {
                return obj['renderers'].split(',');
            } else if ('renderer' in obj) {
                return [obj['renderer']];
            } else {
                return undefined;
            }
        }

       function loadMap() {

           var rasterLayer =
                   new ol.layer.Tile({
                       source: new ol.source.OSM()
                   });

           var view = new ol.View({
               center: [0, 0],
               zoom: 10
           });

           var geolocation = new ol.Geolocation({
               projection: view.getProjection(),
               tracking: true
           });

           map = new ol.Map({
               controls: ol.control.defaults({
                   attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                       collapsible: false
                   }),
                   zoomOptions: /** */ ({
                       zoomInTipLabel: '',
                       zoomOutTipLabel: ''
                   })
               }),
               layers: [rasterLayer],
               target: document.getElementById('mapdiv'),
               view: view
           });
           map.addControl(new ol.control.ZoomSlider());
		   
		   geolocation.once("change:position", function() {
				map.getView().setCenter(geolocation.getPosition());
				var coords = ol.proj.transform(geolocation.getPosition(), view.getProjection().getCode(), 'EPSG:4326');
				$('#longitude').val(coords[1]);
				$('#latitude').val(coords[0]);
		   });

           var accuracyFeature = new ol.Feature({name: 'You are here!'});
           accuracyFeature.bindTo('geometry', geolocation, 'accuracyGeometry');

           var positionFeature = new ol.Feature({name: 'You are here!'});
           positionFeature.bindTo('geometry', geolocation, 'position')
                   .transform(function() {}, function(coordinates) {
                       return coordinates ? new ol.geom.Point(coordinates) : null;
                   });

           var featuresOverlay = new ol.FeatureOverlay({
               map: map,
               features: [accuracyFeature, positionFeature]
           });

           var element = document.getElementById('popup');

           var popup = new ol.Overlay({
               element: element,
               positioning: 'bottom-center',
               stopEvent: false
           });

           // display popup on click
           map.on('click', function(evt) {
               var feature = map.forEachFeatureAtPixel(evt.pixel,
                       function(feature, layer) {
                           return feature;
                       });
               if (feature) {
                   var images = "";
                   for (var i = 0; i < feature.get('data')['occurrenceInfo'].length; i++) {
                       var occ = feature.get('data')['occurrenceInfo'][i];
                       var species = occ['species'];
                       images = images + "<table style='float:left;width:300px'><tr><td></td>";
                       images = images + '<td rowspan=2><a href="#" onClick="getSpeciesInfo(\''+species+'\')">' +
                       '<img src="' + occ['thumbnailURL']  + '"/></a></td></tr><tr><td colspan=2 valign="bottom">' +
                            occ['binomial'] + '</td></tr></table>'
                   }
                   images = images;
                   var imagesElement = document.getElementById('images');
                   imagesElement.style.display = "";
                   imagesElement.innerHTML = images;
               }
           });
           map.addOverlay(popup);

            // change mouse cursor when over marker
           $(map.getViewport()).on('mousemove', function(e) {
               var pixel = map.getEventPixel(e.originalEvent);
               var hit = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                   return true;
               });
               if (hit) {
                   map.getTarget().style.cursor = 'pointer';
               } else {
                   map.getTarget().style.cursor = '';
               }
           });
       }
       
       

        function addFeaturesFor(data) {
            var features = [];
            var locationData = [];
            for (var i = 0; i < data.length; i++) {
                if (locationData[[data[i]['longitude'],data[i]['latitude']]]) {
                    locationData[[data[i]['longitude'],data[i]['latitude']]]['occurrenceInfo'].push(data[i]);
                } else {
                    locationData[[data[i]['longitude'],data[i]['latitude']]] = {
                        geolocation: {
                            longitude: data[i]["longitude"],
                            latitude: data[i]["latitude"]
                        },
                        occurrenceInfo: [data[i]]
                    };
                }
            }

            var iconStyle = new ol.style.Style({
                image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                    anchor: [0.5, 0.5],
                    anchorXUnits: 'fraction',
                    anchorYUnits: 'fraction',
                    opacity: 0.75,
                    src: "pics/icon.png"
                }))
            });

            for (var i = 0; i < Object.keys(locationData).length; i++) {
                var occ = locationData[Object.keys(locationData)[i]];
                var feature = new ol.Feature({
                    data:  occ,
                    name: [occ['geolocation']['longitude'],occ['geolocation']['latitude']],
                    geometry: new ol.geom.Point(ol.proj.transform(
                            [occ['geolocation']['longitude'],
                             occ['geolocation']['latitude']],
                            'EPSG:4326', 'EPSG:3857'))
                });

                feature.setStyle(iconStyle);
                features.push(feature);
            }
            var vectorSource = new ol.source.Vector({features: features});
            var vectorLayer = new ol.layer.Vector({source: vectorSource});
            map.addLayer(vectorLayer);
        }

        var SEARCH_AJAX_FORM = {
            longitude : null,
            latitude : null,

            beforeSubmitHandler:function(arr, form, options) {
                $.each(arr, function(index, aField) {
                    if ('longitude' === aField.name) {
                        longitude = aField.value;
                    } else if ('latitude' === aField.name) {
                        latitude = aField.value;
                    }
                })
                return (longitude && latitude);
            },

            successHandler:function(responseText, status, xhr, form) {
                $.ajax({
                    'url' : 'http://localhost:9998/api/occurrences',
                    'type' : 'GET',
                    'data' : {
                        'longitude' : longitude,
                        'latitude' : latitude
                    },

                    'success' : function(data) {
                        lastSearchresults = data;
                        addFeaturesFor(data);
                    }

                });
            },

            initSearchForm:function() {
                $("#searchform").ajaxForm({
                    beforeSubmit:this.beforeSubmitHandler,
                    success:this.successHandler,
                    clearForm:false
                })
            }
        }

        $(document).ready(function() {
            SEARCH_AJAX_FORM.initSearchForm();
        });
    	
    	function getSpeciesInfo(speciesID){
    		$.ajax({
    		       url: 'http://localhost:9998/api/species?species='+speciesID,
    		       type: 'GET',
    		       dataType: 'application/json',
    		       complete: function(data){
					  var json = $.parseJSON(data.responseText);
					  var species = json['results']['bindings'][0];
					  document.getElementById('scientificName').innerHTML="<h1>"+species['scientificName']['value']+"</h1>";
					  document.getElementById('abstract').innerHTML=species['abstract']['value'];
					  document.getElementById('thumbnail').setAttribute("src",species['thumbnailURL']['value']);
					  $('div#speciesLinks').empty();
					  $.each(species['equivalentWebpages'][0], function(i, item) {
					   	$("<a href=\""+item['equivalentWebpages']['value']+ "\">"+item['equivalentWebpages']['value']+"</a>")
					   		.appendTo("div#speciesLinks");
					   	$("<br></br>").appendTo("div#speciesLinks");
					  });
					  
					  $('div#speciesImages').empty();
					  $.each(species['imageUrls'][0], function(i, item) {
					   	$("<img src=\""+item['imageUrl']['value']+ "\"height=\"300\">")
					   		.appendTo("div#speciesImages");
					  });
					  addTaxonData(species);
					  document.getElementById("mapdiv").style.width="75%";
					  document.getElementById("speciesdiv").style.width="25%";
    		       }
    		})
    	}
    	
    	function addTaxonData(species){
    		var taxonContent = "";
    		taxonContent += "<button type=\"button\" class=\"btn btn-info\" data-toggle=\"collapse\" data-target=\".taxon\">Taxonomy</button>"
    		taxonContent += "<div id=\"kingdom\" class = \"collapse taxon\"> Kingdom:"+ species['kingdom']['value'] + "</div>";
    		taxonContent += "<div id=\"phylum\" class = \"collapse taxon\"> Phylum:"+ species['phylum']['value'] + "</div>";
    		taxonContent += "<div id=\"class\" class = \"collapse taxon\"> Class:"+ species['class']['value'] + "</div>";
    		taxonContent += "<div id=\"order\" class = \"collapse taxon\"> Order:"+ species['order']['value'] + "</div>";
    		taxonContent += "<div id=\"family\" class = \"collapse taxon\"> Family:"+ species['family']['value'] + "</div>";
    		taxonContent += "<div id=\"genus\" class = \"collapse taxon\"> Genus:"+ species['genus']['value'] + "</div>";
    		taxonContent += "<div id=\"species\" class = \"collapse taxon\"> Species:"+ species['scientificName']['value'] + "</div>";
    		
    		document.getElementById('taxondiv').innerHTML=taxonContent;
    	}

    </script>
    <div id="title" style="display:flex;">
        <h3>Taxon-Finder</h3>
        <form id="searchform" style="position:absolute; top:15px; right:5px">
            <label for="longitude">longitude:</label><input name="longitude" type="text" value="13.133317" id="longitude" style="border-radius:10px; -moz-border-radius:10px; -webkit-border-radius:10px;"/>
            <label for="latitude">latitude:</label><input name="latitude" type="text" value="52.394050" id="latitude" style="border-radius:10px; -moz-border-radius:10px; -webkit-border-radius:10px;"/>
            <button class="btn btn-info" type="submit"><i class="glyphicon glyphicon-search"></i></button>
        </form>
    </div>
    <div id="container">
	    <div id="mapdiv">
	        <div id="popup"></div>
	    </div>    
    	<div id="speciesdiv">
    		<div id="taxondiv">
			    <div id="kingdom" class="collapse taxon"></div>
			    <div id="phylum" class="collapse taxon"></div>
			    <div id="class" class="collapse taxon"></div>
			    <div id="order" class="collapse taxon"></div>
			    <div id="family" class="collapse taxon"></div>
			    <div id="genus" class="collapse taxon"></div>
			    <div id="species" class="collapse taxon"></div>
    		</div>
    	    <div id="scientificName"></div>	
    		<div id="abstract"></div>
    		<img id="thumbnail" src="">
    		<div id="speciesLinks"></div>
			<div id="speciesImages"></div>
    	</div>
    <div id="searchdiv" style="display:none; margin-top:50px" onclick="hideDiv()"></div>
    <div id="images" style="overflow-y: scroll; display: none;" onclick="hideDiv()"></div>
    </div>
</body>
</html>